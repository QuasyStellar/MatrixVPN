import os
from aiogram import types
from aiogram.types import FSInputFile
from handlers.protos_menu import protos_menu
from loader import dp, bot
from utils.db_utils import get_user_by_id
from utils.messages_manage import non_authorized

# –¢–µ–∫—Å—Ç—ã –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–π VPN —Å –ø—Ä–µ—Ñ–∏–∫—Å–∞–º–∏ –∏ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π
config_texts = {
    "az_openvpn": {
        "prefix": "AZ-OV",
        "text": "üåç –ò–¥–µ–∞–ª—å–Ω–æ–µ —Å–æ—á–µ—Ç–∞–Ω–∏–µ —Å–∫–æ—Ä–æ—Å—Ç–∏ –∏ –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç–∏! –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –≤—ã–±–æ—Ä —Å–µ—Ç–µ–≤–æ–≥–æ –ø—Ä–æ—Ç–æ–∫–æ–ª–∞ –¥–ª—è –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–π –≥–∏–±–∫–æ—Å—Ç–∏ ‚ú®\n\n<b>FAQ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é —Ñ–∞–π–ª–æ–≤:</b>\n\n <code>&lt;–≤–∞—Ä–∏–∞–Ω—Ç_–≤–ø–Ω&gt;-&lt;–ø—Ä–æ—Ç–æ–∫–æ–ª&gt;-&lt;–¥–∞—Ç–∞_–∞–∫—Ç–∏–≤–∞—Ü–∏–∏–Ω&gt;.*</code>",
    },
    "gb_openvpn": {
        "prefix": "GL-OV",
        "text": "üåç –ò–¥–µ–∞–ª—å–Ω–æ–µ —Å–æ—á–µ—Ç–∞–Ω–∏–µ —Å–∫–æ—Ä–æ—Å—Ç–∏ –∏ –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç–∏! –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –≤—ã–±–æ—Ä —Å–µ—Ç–µ–≤–æ–≥–æ –ø—Ä–æ—Ç–æ–∫–æ–ª–∞ –¥–ª—è –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–π –≥–∏–±–∫–æ—Å—Ç–∏ ‚ú®\n\n<b>FAQ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é —Ñ–∞–π–ª–æ–≤:</b>\n\n <code>&lt;–≤–∞—Ä–∏–∞–Ω—Ç_–≤–ø–Ω&gt;-&lt;–ø—Ä–æ—Ç–æ–∫–æ–ª&gt;-&lt;–¥–∞—Ç–∞_–∞–∫—Ç–∏–≤–∞—Ü–∏–∏–Ω&gt;.*</code>",
    },
    "az_amneziawg": {
        "prefix": "AZ-AM",
        "text": "üïä –û—â—É—Ç–∏—Ç–µ —Å–≤–æ–±–æ–¥—É –≤ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–µ c <b>—É–ª—É—á—à–µ–Ω–Ω—ã–º –º–µ—Ö–∞–Ω–∏–∑–º–æ–º —Å–∫—Ä—ã—Ç–∏—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ VPN</b> ü•∑\n\n<b>FAQ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é —Ñ–∞–π–ª–æ–≤:</b>\n\n <code>&lt;–≤–∞—Ä–∏–∞–Ω—Ç_–≤–ø–Ω&gt;-&lt;–ø—Ä–æ—Ç–æ–∫–æ–ª&gt;-&lt;–¥–∞—Ç–∞_–∞–∫—Ç–∏–≤–∞—Ü–∏–∏–Ω&gt;.*</code>",
    },
    "gb_amneziawg": {
        "prefix": "GL-AM",
        "text": "üôà –í–∞—à–µ –±–µ–∑–æ–ø–∞—Å–Ω–æ–µ –ø—É—Ç–µ—à–µ—Å—Ç–≤–∏–µ –ø–æ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç—É <b>–±–µ–∑ –±–ª–æ–∫–∏—Ä–æ–≤–æ–∫</b> –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è –∑–¥–µ—Å—å! <b>–ó–∞—â–∏—Ç–∏—Ç–µ —Å–≤–æ—é –ø—Ä–∏–≤–∞—Ç–Ω–æ—Å—Ç—å</b> –∏ <b>–æ—Å—Ç–∞–≤–∞–π—Ç–µ—Å—å –∞–Ω–æ–Ω–∏–º–Ω—ã–º!</b> üïµÔ∏è‚Äç‚ôÇÔ∏è\n\n<b>FAQ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é —Ñ–∞–π–ª–æ–≤:</b>\n\n <code>&lt;–≤–∞—Ä–∏–∞–Ω—Ç_–≤–ø–Ω&gt;-&lt;–ø—Ä–æ—Ç–æ–∫–æ–ª&gt;-&lt;–¥–∞—Ç–∞_–∞–∫—Ç–∏–≤–∞—Ü–∏–∏–Ω&gt;.*</code>",
    },
    "az_wireguard": {
        "prefix": "AZ-WG",
        "text": "‚ö° –û–±—Ö–æ–¥–∏—Ç–µ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ –∏ –ø–æ–ª—É—á–∞–π—Ç–µ –¥–æ—Å—Ç—É–ø –∫ –ª—é–±–∏–º—ã–º —Å–∞–π—Ç–∞–º —Å <b>–≤—ã—Å–æ–∫–æ–π —Å–∫–æ—Ä–æ—Å—Ç—å—é</b>! üåä\n\n<b>FAQ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é —Ñ–∞–π–ª–æ–≤:</b>\n\n <code>&lt;–≤–∞—Ä–∏–∞–Ω—Ç_–≤–ø–Ω&gt;-&lt;–ø—Ä–æ—Ç–æ–∫–æ–ª&gt;-&lt;–¥–∞—Ç–∞_–∞–∫—Ç–∏–≤–∞—Ü–∏–∏–Ω&gt;.*</code>",
    },
    "gb_wireguard": {
        "prefix": "GL-WG",
        "text": "üîí –ü–æ–ª—É—á–∏—Ç–µ <b>–º–∞–∫—Å–∏–º–∞–ª—å–Ω—É—é –∑–∞—â–∏—Ç—É –∏ –∞–Ω–æ–Ω–∏–º–Ω–æ—Å—Ç—å</b> –ø—Ä–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–∏ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–∞. –í–∞—à–∏ –¥–∞–Ω–Ω—ã–µ –ø–æ–¥ –Ω–∞–¥–µ–∂–Ω–æ–π –∑–∞—â–∏—Ç–æ–π! üîê\n\n<b>FAQ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é —Ñ–∞–π–ª–æ–≤:</b>\n\n <code>&lt;–≤–∞—Ä–∏–∞–Ω—Ç_–≤–ø–Ω&gt;-&lt;–ø—Ä–æ—Ç–æ–∫–æ–ª&gt;-&lt;–¥–∞—Ç–∞_–∞–∫—Ç–∏–≤–∞—Ü–∏–∏–Ω&gt;.*</code>",
    },
}


@dp.callback_query(lambda call: call.data in config_texts.keys())
async def send_configs_callback(call: types.CallbackQuery) -> None:
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ—Ç–ø—Ä–∞–≤–∫–∏ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–π VPN –≤ –æ—Ç–≤–µ—Ç –Ω–∞ –∑–∞–ø—Ä–æ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è."""
    user_id = call.from_user.id
    user = await get_user_by_id(user_id)

    # –ü—Ä–æ–≤–µ—Ä–∫–∞, –∏–º–µ–µ—Ç –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –¥–æ—Å—Ç—É–ø –∫ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è–º
    if user and user[2] == "accepted":
        config = config_texts[call.data]  # –ü–æ–ª—É—á–∞–µ–º –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é –ø–æ –∫–ª—é—á—É
        file_type = (
            "conf" if "WG" in config["prefix"] or "AM" in config["prefix"] else "ovpn"
        )  # –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–∏–ø —Ñ–∞–π–ª–∞
        file_prefix = config["prefix"]  # –ü–æ–ª—É—á–∞–µ–º –ø—Ä–µ—Ñ–∏–∫—Å —Ñ–∞–π–ª–∞
        # –ü—Ä–æ—Ö–æ–¥–∏–º –ø–æ –≤—Å–µ–º —Ñ–∞–π–ª–∞–º –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        for file in os.listdir(f"/root/vpn/n{user_id}"):
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –ª–∏ —Ñ–∞–π–ª –ø—Ä–µ—Ñ–∏–∫—Å—É –∏ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—é
            if file.startswith(file_prefix) and file.endswith(f".{file_type}"):
                caption = config["text"]  # –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—Å—Ç –¥–ª—è –ø–æ–¥–ø–∏—Å–∏
                # –§–æ—Ä–º–∏—Ä—É–µ–º —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â—É—é –∫–Ω–æ–ø–∫—É –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–∏–ø–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
                if file_type == "ovpn":
                    app_url = "https://openvpn.net/client/"
                elif "WG" in config["prefix"]:
                    app_url = "https://www.wireguard.com/install/"
                elif "AM" in config["prefix"]:
                    app_url = "https://docs.amnezia.org/ru/documentation/amnezia-wg/"
                else:
                    app_url = None

                # –°–æ–∑–¥–∞–µ–º Inline-–∫–Ω–æ–ø–∫—É, –µ—Å–ª–∏ URL –æ–ø—Ä–µ–¥–µ–ª–µ–Ω
                markup = (
                    types.InlineKeyboardMarkup(
                        inline_keyboard=[
                            [
                                types.InlineKeyboardButton(
                                    text="‚¨áÔ∏è –°–∫–∞—á–∞—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ",
                                    web_app=types.WebAppInfo(url=app_url),
                                )
                            ]
                        ]
                    )
                    if app_url
                    else None
                )

                # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ñ–∞–π–ª –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
                await bot.send_document(
                    user_id,
                    FSInputFile(f"/root/vpn/n{user_id}/{file}"),
                    caption=caption,
                    parse_mode="HTML",
                    reply_markup=markup,  # –î–æ–±–∞–≤–ª—è–µ–º –∫–Ω–æ–ø–∫—É, –µ—Å–ª–∏ –æ–Ω–∞ –µ—Å—Ç—å
                )

                if "AZ" in config["prefix"]:
                    await protos_menu(user_id=user_id, proto="az")
                else:
                    await protos_menu(user_id=user_id, proto="gb")

                break  # –ó–∞–≤–µ—Ä—à–∞–µ–º —Ü–∏–∫–ª –ø–æ—Å–ª–µ –æ—Ç–ø—Ä–∞–≤–∫–∏ –ø–µ—Ä–≤–æ–≥–æ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–µ–≥–æ —Ñ–∞–π–ª–∞

    else:
        # –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω, –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
        await non_authorized(call.from_user.id, call.message.message_id)
