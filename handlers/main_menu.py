from aiogram import types
from aiogram.types import FSInputFile
import random
from loader import dp, bot
from utils.db_utils import get_user_by_id
from utils.messages_manage import non_authorized

from pytils import numeral
from datetime import datetime
from babel.dates import format_datetime
import pytz

quotes = [
    "–í—Å—Ç–∞–≤–∞–π, –¢—Ä–∏–Ω–∏—Ç–∏. –í—Å—Ç–∞–≤–∞–π! –ù–∞–¥–æ –≤—Å—Ç–∞—Ç—å!",
    "–ü—Ä–æ—Å–Ω–∏—Å—å, –ù–µ–æ‚Ä¶",
    "–¢—ã —É–≤—è–∑ –≤ –ú–∞—Ç—Ä–∏—Ü–µ.",
    "–°–ª–µ–¥—É–π –∑–∞ –±–µ–ª—ã–º –∫—Ä–æ–ª–∏–∫–æ–º.",
    "–¢—É–∫-—Ç—É–∫, –ù–µ–æ.",
    "–≠—Ç—É –¥–æ—Ä–æ–≥—É —Ç—ã –≤–∏–¥–µ–ª. –ò –∑–Ω–∞–µ—à—å, –∫—É–¥–∞ –æ–Ω–∞ –≤–µ–¥—ë—Ç. –¢–µ–±–µ —Ç—É–¥–∞ –Ω–µ –Ω—É–∂–Ω–æ, —è —É–≤–µ—Ä–µ–Ω–∞.",
    "–ù–µ–æ, —è –±–æ–ª—å—à–µ –Ω–µ –±–æ—é—Å—å. –ü—Ä–æ–≤–∏–¥–∏—Ü–∞ –ø—Ä–µ–¥—Å–∫–∞–∑–∞–ª–∞ –º–Ω–µ, —á—Ç–æ —è –¥–æ–ª–∂–Ω–∞ –≤–ª—é–±–∏—Ç—å—Å—è. –ò –º–æ–π –ª—é–±–∏–º—ã–π ‚Äî –ò–∑–±—Ä–∞–Ω–Ω—ã–π. –ê –∑–Ω–∞—á–∏—Ç, —Ç—ã –Ω–µ —É–º—Ä—ë—à—å.",
    "–î–æ–≥–∞–¥—ã–≤–∞—é—Å—å, —Å–µ–π—á–∞—Å —Ç—ã —á—É–≤—Å—Ç–≤—É–µ—à—å —Å–µ–±—è –ê–ª–∏—Å–æ–π, –ø–∞–¥–∞—é—â–µ–π –≤ –∫—Ä–æ–ª–∏—á—å—é –Ω–æ—Ä—É‚Ä¶",
    "–í—Ä–µ–º—è –≤—Å–µ–≥–¥–∞ –ø—Ä–æ—Ç–∏–≤ –Ω–∞—Å.",
    "–°–ª—É—á–∞–ª–æ—Å—å –≤–∏–¥–µ—Ç—å —Å–æ–Ω, –∫–∞–∑–∞–≤—à–∏–π—Å—è —Ä–µ–∞–ª—å–Ω–æ—Å—Ç—å—é? –ß—Ç–æ, –µ—Å–ª–∏ –±—ã —Ç—ã –Ω–µ —Å–º–æ–≥ –ø—Ä–æ—Å–Ω—É—Ç—å—Å—è? –ö–∞–∫ –±—ã —Ç—ã —É–∑–Ω–∞–ª, —á—Ç–æ —Ç–∞–∫–æ–µ —Å–æ–Ω, –∞ —á—Ç–æ –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å?",
    "–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ —Ä–µ–∞–ª—å–Ω—ã–π –º–∏—Ä.",
    "–ß—Ç–æ –µ—Å—Ç—å —Ä–µ–∞–ª—å–Ω–æ—Å—Ç—å? –ò –∫–∞–∫ –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –µ—ë? –ï—Å—Ç—å –Ω–∞–±–æ—Ä –æ—â—É—â–µ–Ω–∏–π, –∑—Ä–∏—Ç–µ–ª—å–Ω—ã—Ö, –æ—Å—è–∑–∞—Ç–µ–ª—å–Ω—ã—Ö, –æ–±–æ–Ω—è—Ç–µ–ª—å–Ω—ã—Ö ‚Äî —ç—Ç–æ —Å–∏–≥–Ω–∞–ª—ã —Ä–µ—Ü–µ–ø—Ç–æ—Ä–æ–≤, —ç–ª–µ–∫—Ç—Ä–∏—á–µ—Å–∫–∏–µ –∏–º–ø—É–ª—å—Å—ã, –≤–æ—Å–ø—Ä–∏–Ω—è—Ç—ã–µ –º–æ–∑–≥–æ–º.",
    "–ß—Ç–æ —Ç–∞–∫–æ–µ ¬´–ú–∞—Ç—Ä–∏—Ü–∞¬ª? –î–∏–∫—Ç–∞—Ç.",
    "–Ø –Ω–µ –≥–æ–≤–æ—Ä–∏–ª, —á—Ç–æ –±—É–¥–µ—Ç –ª–µ–≥–∫–æ, –ù–µ–æ. –Ø –ª–∏—à—å –æ–±–µ—â–∞–ª, —á—Ç–æ —ç—Ç–æ –±—É–¥–µ—Ç –ø—Ä–∞–≤–¥–∞.",
    "–¢—ã –¥—É–º–∞–µ—à—å, —á—Ç–æ –º–æ—è —Ä–µ–∞–∫—Ü–∏—è –∏–ª–∏ —Å–∏–ª–∞ –∑–¥–µ—Å—å, –≤ —ç—Ç–æ–º –º–∏—Ä–µ, –∑–∞–≤–∏—Å—è—Ç –æ—Ç –º—É—Å–∫—É–ª–æ–≤? –¢—ã –¥—É–º–∞–µ—à—å, —á—Ç–æ –¥—ã—à–∏—à—å –≤–æ–∑–¥—É—Ö–æ–º —Å–µ–π—á–∞—Å?‚Ä¶",
    "–¢—ã –º–æ–∂–µ—à—å –±—ã—Å—Ç—Ä–µ–µ. –ù–µ –¥—É–º–∞–π, —á—Ç–æ —Ç—ã –±—ã—Å—Ç—Ä ‚Äî –∑–Ω–∞–π, —á—Ç–æ —Ç—ã –±—ã—Å—Ç—Ä. –•–≤–∞—Ç–∏—Ç –ø–æ–ø—ã—Ç–æ–∫. –ù–µ –ø—ã—Ç–∞–π—Å—è —É–¥–∞—Ä–∏—Ç—å –º–µ–Ω—è –∏ –ø—Ä–æ—Å—Ç–æ —É–¥–∞—Ä—å –º–µ–Ω—è.",
    "–ü–æ—Ä–∞ –æ—Å–≤–æ–±–æ–¥–∏—Ç—å —Ç–≤–æ–π —Ä–∞–∑—É–º. –ù–æ —è –º–æ–≥—É –ª–∏—à—å —É–∫–∞–∑–∞—Ç—å –¥–≤–µ—Ä—å. –¢—ã —Å–∞–º –¥–æ–ª–∂–µ–Ω –≤—ã–π—Ç–∏ –Ω–∞ –≤–æ–ª—é. ‚Ä¶ –û—Ç–≤–ª–µ–∫–∏—Å—å –æ—Ç –≤—Å–µ–≥–æ, –ù–µ–æ. –°—Ç—Ä–∞—Ö, –Ω–µ–≤–µ—Ä–∏–µ, —Å–æ–º–Ω–µ–Ω–∏—è –æ—Ç–±—Ä–æ—Å—å ‚Äî –æ—á–∏—Å—Ç–∏ —Å–≤–æ–π —Ä–∞–∑—É–º.",
    "–†–µ–∞–ª—å–Ω–æ —Ç–æ, —á—Ç–æ –æ—Å–æ–∑–Ω–∞–µ—à—å.",
    "–ú–∞—Ç—Ä–∏—Ü–∞ ‚Äî —ç—Ç–æ —Å–∏—Å—Ç–µ–º–∞. –°–∏—Å—Ç–µ–º–∞ ‚Äî –µ—Å—Ç—å –Ω–∞—à –≤—Ä–∞–≥. –ù–æ –∫–æ–≥–¥–∞ —Ç—ã –≤ –Ω–µ–π ‚Äî –æ–≥–ª—è–Ω–∏—Å—å, –∫–æ–≥–æ —Ç—ã –≤–∏–¥–∏—à—å? –ë–∏–∑–Ω–µ—Å–º–µ–Ω–æ–≤, —É—á–∏—Ç–µ–ª–µ–π, –∞–¥–≤–æ–∫–∞—Ç–æ–≤, —Ä–∞–±–æ—Ç—è–≥, –æ–±—ã—á–Ω—ã—Ö –ª—é–¥–µ–π, —á–µ–π —Ä–∞–∑—É–º –º—ã –∏ —Å–ø–∞—Å–∞–µ–º.",
    "–†–∞–Ω–æ –∏–ª–∏ –ø–æ–∑–¥–Ω–æ —Ç—ã –ø–æ–π–º—ë—à—å, –∫–∞–∫ –∏ —è. –ó–Ω–∞—Ç—å –ø—É—Ç—å –∏ –ø—Ä–æ–π—Ç–∏ –µ–≥–æ ‚Äî –Ω–µ –æ–¥–Ω–æ –∏ —Ç–æ–∂–µ.",
    "–û–Ω –Ω–∞—á–∏–Ω–∞–µ—Ç –≤–µ—Ä–∏—Ç—å.",
    "–ü—Ä–∏—Å—Ç–µ–≥–Ω–∏ —Ä–µ–º–µ–Ω—å, –î–æ—Ä–æ—Ç–∏, –∏ —Å–∫–∞–∂–∏ –ö–∞–Ω–∑–∞—Å—É: ¬´–ü—Ä–æ—Å—Ç–∏ –∏ –ø—Ä–æ—â–∞–π¬ª.",
    "–í—Å–µ –º—ã –ø–∞–¥–∞–ª–∏ –≤ –ø–µ—Ä–≤—ã–π —Ä–∞–∑.",
    "–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏, –ø–æ–ª—É—á–∞–µ–º–æ–π –∏–∑ –ú–∞—Ç—Ä–∏—Ü—ã, –≥–æ—Ä–∞–∑–¥–æ –±–æ–ª—å—à–µ, —á–µ–º —Ç—ã –º–æ–∂–µ—à—å —Ä–∞—Å—à–∏—Ñ—Ä–æ–≤–∞—Ç—å. –¢—ã –ø—Ä–∏–≤—ã–∫–Ω–µ—à—å –∫ —ç—Ç–æ–º—É.",
    "–Ø –∑–Ω–∞—é, –æ–Ω –Ω–µ –Ω–∞—Å—Ç–æ—è—â–∏–π, –∏ –∫–æ–≥–¥–∞ —è –ø–æ–ª–æ–∂—É –µ–≥–æ –≤ —Ä–æ—Ç, –≤–∫—É—Å –≤–Ω—É—à–∏—Ç –º–Ω–µ –ú–∞—Ç—Ä–∏—Ü–∞. –ó–Ω–∞–µ—Ç–µ, —á—Ç–æ —è —Ä–µ—à–∏–ª –∑–∞ —Ç–µ –¥–µ—Å—è—Ç—å –ª–µ—Ç, —á—Ç–æ —Å–≤–æ–±–æ–¥–µ–Ω? –°—á–∞—Å—Ç—å–µ –≤ –Ω–µ–≤–µ–¥–µ–Ω–∏–∏.",
    "–í—Å—ë, —á—Ç–æ —è –¥–µ–ª–∞–ª ‚Äî —ç—Ç–æ —Ç–æ, —á—Ç–æ –æ–Ω –≥–æ–≤–æ—Ä–∏–ª –º–Ω–µ –¥–µ–ª–∞—Ç—å.",
    "–ö–∞–∫ –≤–∏–¥–∏—Ç–µ, –º—ã –∑–∞ –í–∞–º–∏ –¥–∞–≤–Ω–µ–Ω—å–∫–æ –Ω–∞–±–ª—é–¥–∞–µ–º, –º–∏—Å—Ç–µ—Ä –ê–Ω–¥–µ—Ä—Å–æ–Ω.",
    "–í–∞–º —Å–ª—É—á–∞–ª–æ—Å—å –ª—é–±–æ–≤–∞—Ç—å—Å—è –ú–∞—Ç—Ä–∏—Ü–µ–π? –ï—ë –≥–µ–Ω–∏–∞–ª—å–Ω–æ—Å—Ç—å—é‚Ä¶",
    "–ù–∏–∫–æ–≥–¥–∞ –Ω–µ –ø–æ—Å—ã–ª–∞–π—Ç–µ —á–µ–ª–æ–≤–µ–∫–∞ –¥–µ–ª–∞—Ç—å —Ä–∞–±–æ—Ç—É –º–∞—à–∏–Ω—ã.",
    "–Ø —Ö–æ—á—É –ø–æ–¥–µ–ª–∏—Ç—å—Å—è —Ç–µ–æ—Ä–∏–µ–π, –∫–æ—Ç–æ—Ä—É—é –Ω–µ–¥–∞–≤–Ω–æ —Å–æ–∑–¥–∞–ª. –Ø –∑–∞–Ω–∏–º–∞–ª—Å—è –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏–µ–π –±–∏–æ–ª–æ–≥–∏—á–µ—Å–∫–∏—Ö –≤–∏–¥–æ–≤ –∏ –ø—Ä–∏—à—ë–ª –∫ –≤—ã–≤–æ–¥—É, —á—Ç–æ –≤—ã ‚Äî –Ω–µ –º–ª–µ–∫–æ–ø–∏—Ç–∞—é—â–∏–µ.",
    "–Ø —ç—Ç–æ—Ç –≥–æ—Ä–æ–¥‚Ä¶ –Ω–µ–Ω–∞–≤–∏–∂—É. –≠—Ç–æ—Ç –∑–æ–æ–ø–∞—Ä–∫, —Ç—é—Ä—å–º—É, —ç—Ç—É —Ä–µ–∞–ª—å–Ω–æ—Å—Ç—å ‚Äî –Ω–∞–∑—ã–≤–∞–π—Ç–µ –∫–∞–∫ —Ö–æ—Ç–∏—Ç–µ.",
    "–£–±–∏—Ç—å –í–∞—Å ‚Äî –Ω–∞—Å–ª–∞–∂–¥–µ–Ω–∏–µ, –º–∏—Å—Ç–µ—Ä –ê–Ω–¥–µ—Ä—Å–æ–Ω.",
    "–ë—ã—Ç—å –ò–∑–±—Ä–∞–Ω–Ω—ã–º –≤—Å—ë —Ä–∞–≤–Ω–æ —á—Ç–æ –±—ã—Ç—å –≤–ª—é–±–ª—ë–Ω–Ω—ã–º. –ù–∏–∫—Ç–æ –Ω–µ –≥–æ–≤–æ—Ä–∏—Ç —Ç–µ–±–µ, —á—Ç–æ —Ç—ã –≤–ª—é–±–ª—ë–Ω. –¢—ã –ø—Ä–æ—Å—Ç–æ –∑–Ω–∞–µ—à—å —ç—Ç–æ.",
    "–î–∞—Ä —É —Ç–µ–±—è –µ—Å—Ç—å, –Ω–æ, –∫–∞–∂–µ—Ç—Å—è, —Ç—ã —á–µ–≥–æ-—Ç–æ –∂–¥—ë—à—å.",
    "–ì–ª–∞–≤–Ω–æ–µ, –Ω–µ –≤–µ—Ä—å –≤—Å—è–∫–æ–π –µ—Ä—É–Ω–¥–µ –Ω–∞—Å—á—ë—Ç —Å—É–¥—å–±—ã. –¢—ã —Ö–æ–∑—è–∏–Ω —Å–≤–æ–µ–π –∂–∏–∑–Ω–∏.",
    "–¢–∞–∫, –ø–æ–ª–æ–∂–µ–Ω–æ –ø—Ä–æ–≤–æ–¥–∏—Ç—å —Ç–µ—Ö. –ø–æ–¥–≥–æ—Ç–æ–≤–∫—É. –ù–æ —ç—Ç–æ —Ç–æ—Å–∫–∞ –∑–µ–ª—ë–Ω–∞—è. –ö–∞–∫ –Ω–∞—Å—á—ë—Ç –ø—Ä–µ–¥–º–µ—Ç–∞ –ø–æ–≤–µ—Å–µ–ª–µ–π?",
    "–ú–æ–∂–µ—Ç –º–∞—à–∏–Ω—ã –Ω–µ –∑–Ω–∞–ª–∏ –∫–∞–∫–æ–π –Ω–∞ –≤–∫—É—Å —Ü—ã–ø–ª—ë–Ω–æ–∫, –ø–æ—ç—Ç–æ–º—É —Ü—ã–ø–ª—ë–Ω–æ–∫ –Ω–∞ –≤–∫—É—Å –∫–∞–∫ –≤–æ–æ–±—â–µ –≤—Å—ë.",
    "–≠—Ç–æ –≤—Å–µ–≥–æ –ª–∏—à—å –±–µ–ª–æ–∫ –æ–¥–Ω–æ–∫–ª–µ—Ç–æ—á–Ω—ã—Ö, —Å–º–µ—à–∞–Ω–Ω—ã–π —Å —Å–∏–Ω—Ç–µ—Ç–∏—á–µ—Å–∫–∏–º–∏ –∞–º–∏–Ω–æ–∫–∏—Å–ª–æ—Ç–∞–º–∏, –≤–∏—Ç–∞–º–∏–Ω–∞–º–∏ –∏ –º–∏–Ω–µ—Ä–∞–ª—å–Ω—ã–º–∏ –≤–µ—â–µ—Å—Ç–≤–∞–º–∏.",
    "–ù–µ –æ–±—Ä–∞—â–∞–π –≤–Ω–∏–º–∞–Ω–∏—è –Ω–∞ —ç—Ç–∏—Ö –ª–∏—Ü–µ–º–µ—Ä–æ–≤. –ò–Ω—Å—Ç–∏–Ω–∫—Ç—ã –∏ —Å–ª–∞–±–æ—Å—Ç–∏ –∫–∞–∫ —Ä–∞–∑ –∏ –æ—Ç–ª–∏—á–∞—é—Ç –Ω–∞—Å –æ—Ç –º–µ—Ä–∑–∫–∏—Ö –º–∞—à–∏–Ω.",
    "–û–±—Ä–∞—Ç–∏—Ç–µ –≤–Ω–∏–º–∞–Ω–∏–µ. –ó–∞–∂–≥–ª–∏—Å—å —Ç–∞–±–ª–æ ¬´–ù–µ –∫—É—Ä–∏—Ç—å¬ª –∏ ¬´–ü—Ä–∏—Å—Ç–µ–≥–Ω—É—Ç—å —Ä–µ–º–Ω–∏¬ª. –≠–∫–∏–ø–∞–∂ –∂–µ–ª–∞–µ—Ç –í–∞–º –ø—Ä–∏—è—Ç–Ω–æ–≥–æ –ø–æ–ª—ë—Ç–∞.",
]


@dp.callback_query(lambda call: call.data == "main_menu")
async def main_menu(call: types.CallbackQuery = None, user_id: int = None):
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –≥–ª–∞–≤–Ω–æ–≥–æ –º–µ–Ω—é VPN."""

    # –ü–æ–ª—É—á–∞–µ–º user_id, –µ—Å–ª–∏ –µ–≥–æ –Ω–µ—Ç –≤ –∞—Ä–≥—É–º–µ–Ω—Ç–∞—Ö, –∏—Å–ø–æ–ª—å–∑—É–µ–º call.from_user.id
    user_id = user_id or call.from_user.id

    # –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ –±–∞–∑—ã
    user = await get_user_by_id(user_id)
    if not (user and user[2] == "accepted"):  # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å
        await non_authorized(user_id, call.message.message_id)
        return

    access_end_date = user[5]  # –ò–∑–≤–ª–µ–∫–∞–µ–º username –∏ –¥–∞—Ç—É –æ–∫–æ–Ω—á–∞–Ω–∏—è

    # –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º –¥–∞—Ç—É –æ–∫–æ–Ω—á–∞–Ω–∏—è –¥–æ—Å—Ç—É–ø–∞
    access_end_date = datetime.fromisoformat(access_end_date)
    current_date = datetime.now(pytz.utc)

    # –í—ã—á–∏—Å–ª—è–µ–º –æ—Å—Ç–∞–≤—à–µ–µ—Å—è –≤—Ä–µ–º—è
    remaining_time = access_end_date - current_date
    remaining_days = remaining_time.days
    remaining_hours = remaining_time.total_seconds() // 3600

    end_date_formatted = format_datetime(
        access_end_date.replace(tzinfo=pytz.utc).astimezone(
            pytz.timezone("Europe/Moscow")
        ),
        "d MMMM yyyy '–≤' HH:mm",
        locale="ru",
    )

    # –û–ø—Ä–µ–¥–µ–ª—è–µ–º, —á—Ç–æ –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å: –¥–Ω–∏ –∏–ª–∏ —á–∞—Å—ã
    if remaining_days < 3:
        time_text = f"{numeral.get_plural(int(remaining_hours), '—á–∞—Å, —á–∞—Å–∞, —á–∞—Å–æ–≤')}"

    else:
        time_text = f"{numeral.get_plural(remaining_days, '–¥–µ–Ω—å, –¥–Ω—è, –¥–Ω–µ–π')}"

    # –†–∞–∑–º–µ—Ç–∫–∞ –¥–ª—è –≥–ª–∞–≤–Ω–æ–≥–æ –º–µ–Ω—é
    menu = types.InlineKeyboardMarkup(
        inline_keyboard=[
            [
                types.InlineKeyboardButton(
                    text="üí° –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ VPN", callback_data="vpn_variants"
                ),
            ],
            [
                types.InlineKeyboardButton(
                    text="üõ† –ù–∞—Å—Ç—Ä–æ–π–∫–∏", callback_data="settings"
                ),
            ],
            [
                types.InlineKeyboardButton(
                    text="‚ùì –ü–æ–¥–¥–µ—Ä–∂–∫–∞", url="tg://user?id=6522480240"
                ),
            ],
        ]
    )

    # –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Ç–µ–∫—Å—Ç–∞ —Å–æ–æ–±—â–µ–Ω–∏—è
    caption_text = f"""
‚ìò <b>–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å!</b>

<blockquote>
<b>‚è≥ –û—Å—Ç–∞–ª–æ—Å—å: {time_text}
üìÖ –î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è: {end_date_formatted}
</blockquote>

<blockquote><b>üí¨ ¬´{random.choice(quotes)}¬ª</b></blockquote>
"""

    # –†–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º —Ç–µ–∫—É—â–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –∏–ª–∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–æ–≤–æ–µ
    if call:
        await call.message.edit_media(
            media=types.InputMediaPhoto(
                media=FSInputFile("assets/matrix.png"),
                caption=caption_text,
                parse_mode="HTML",
            ),
            reply_markup=menu,
        )
    else:
        await bot.send_photo(
            chat_id=user_id,
            photo=FSInputFile("assets/matrix.png"),
            caption=caption_text,
            parse_mode="HTML",
            reply_markup=menu,
        )
